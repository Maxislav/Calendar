var calendarModule=angular.module("calendarModule",[]).constant("constantCalendar",{days:["П","B","C","Ч","П","С","B"],month:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]});calendarModule.directive("calendar",["$compile","$templateCache","constantCalendar","$timeout","factoryPosition",function(a,b,c,d,e){function f(a,b,c){function d(a){var b="";return i==a.getTime()&&(b+="current"),h?g<a.getTime()+864e5&&g>=a.getTime()&&(b+=" select"):e<=a.getTime()&&a.getTime()<=f&&(b+=" select"),b}var e,f,g,h=c?!1:!0,i=new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()).getTime();h?g=b.getTime():(e=b.getTime(),f=c.getTime());for(var j=[],k=0;50>k;k++){var l=new Date(a.getFullYear(),a.getMonth(),k);l.getMonth()==a.getMonth()&&j.push({date:l,value:l.getTime(),dayWeek:l.getDay(),"class":d(l)})}for(var m=0==j[0].dayWeek?6:j[0].dayWeek-1,n=0==j[j.length-1].dayWeek?0:7-j[j.length-1].dayWeek,k=0;m>k;k++)j.unshift(null);for(var k=0;n>k;k++)j.push(null);for(var o=parseFloat((j.length/7).toFixed(0)),p=[],q=0,k=0;o>k;k++){p[k]=[];for(var l=0;7>l;l++)p[k].push(j[q]),q++}return p}return{restrict:"EA",replace:!0,templateUrl:"module/partials/calendar-label.html",scope:{before:"=before",after:"=after",link:"@link",exact:"="},controller:["$scope","$element","$attrs","$timeout","$templateCache",function(a,b){function d(b){k=new Date(b.getFullYear(),b.getMonth()-1,b.getDate()),l=new Date(b.getFullYear(),b.getMonth()+1,b.getDate()),i?(a.arrMonth=f(b,a.exact),a.arrMonth.value=b.getTime(),a.arrMonthBefore=f(k,a.exact),a.arrMonthBefore.value=k.getTime(),a.arrMonthAfter=f(l,a.exact),a.arrMonthAfter.value=l.getTime()):(a.arrMonth=f(b,a.after,a.before),a.arrMonth.value=b.getTime(),a.arrMonthBefore=f(k,a.after,a.before),a.arrMonthBefore.value=k.getTime(),a.arrMonthAfter=f(l,a.after,a.before),a.arrMonthAfter.value=l.getTime())}function e(c){var d=!1;angular.forEach(a.calendarElement.find("*"),function(a){return a==c.target?void(d=!0):void 0}),d||angular.forEach(b.find("*"),function(a){return a==c.target?void(d=!0):void 0}),d||(a.show=!1,a.$apply())}function g(){window.document.removeEventListener("click",e)}var h="true"==a.link?!0:!1,i=a.exact?!0:!1;a.show=!1,a.constantCalendar=c,a.beforeLabelValue=a.before,a.afterLabelValue=a.after;var j;j=i?a.exact:new Date(a.after.getTime()+(a.before.getTime()-a.after.getTime())/2);var k,l;a.includeMonths="module/partials/container-months.html",d(j),a.stepBack=function(){var a=new Date(j.getFullYear(),j.getMonth()-1,j.getDate());j=a,d(a)},a.stepForward=function(){var a=new Date(j.getFullYear(),j.getMonth()+1,j.getDate());j=a,d(a)},a.selectEvent=function(b){i?a.exact=new Date(b.value):a.before.getTime()<b.value?a.before=new Date(b.value):b.value<a.after.getTime()?a.after=new Date(b.value):(a.after=new Date(b.value),a.before=new Date(b.value)),h&&(a.beforeLabelValue=a.before,a.afterLabelValue=a.after)},a.apply=function(){a.click()},a.$watch("before",function(){d(j)}),a.$watch("after",function(){d(j)}),a.$watch("exact",function(){d(j)}),a.$watch("show",function(a){a?window.document.addEventListener("click",e):window.document.removeEventListener("click",e)}),a.$on("$destroy",function(){console.log("destroy"),g()})}],link:function(c,f){function g(){var g=a(b.get("module/partials/calendar-view.html"));h=g(c),h.css("display","none");var i=angular.element(document.body);i.append(h),c.calendarElement=h,d(function(){c.show=!0,h.css("display","inherit"),h.css("left",e(f[0]).x+100+"px"),h.css("top",e(f[0]).y+25+"px")},1)}var h=null;c.show=!1,c.click=function(){return h?void(c.show=!c.show):void g()}}}}]),calendarModule.directive("daysweek",["$compile","constantCalendar",function(a,b){return{restrict:"E",replace:!0,scope:{},templateUrl:"module/partials/calendar-days.html",controller:["$scope",function(a){a.constantCalendar=b}]}}]),calendarModule.factory("factoryPosition",function(){function a(a){var b=0;if(a.offsetParent)for(;;){if(b+=a.offsetLeft,!a.offsetParent)break;a=a.offsetParent}else a.x&&(b+=a.x);return b}function b(a){var b=0;if(a.offsetParent)for(;;){if(b+=a.offsetTop,!a.offsetParent)break;a=a.offsetParent}else a.y&&(b+=a.y);return b}function c(c){return{x:a(c),y:b(c)}}return c}),angular.module("calendarModule").run(["$templateCache",function(a){"use strict";a.put("module/partials/calendar-days.html",'<div class="row days"><div class="col-day text-right" ng-repeat="days in constantCalendar.days track by $index"><span ng-switch="$index"><span ng-switch-when="6" class="red">{{days}}</span> <span ng-switch-when="5" class="red">{{days}}</span> <span ng-switch-default>{{days}}</span></span></div></div>'),a.put("module/partials/calendar-label.html",'<div class="calendar-label"><div class="calendar-label-ico" ng-click="click()"><div class="ico-calendar">&nbsp;</div></div><div class="calendar-label-btn" ng-class="show && \'open\'" ng-click="click()" ng-if="!exact">{{after | date:\'dd MMM\'}} - {{beforeLabelValue | date:\'dd MMM\'}} {{before | date:\'yyyy\'}}</div><div class="calendar-label-btn" ng-class="show && \'open\'" ng-click="click()" ng-if="exact">{{exact | date:\'dd MMMM yyyy\'}}</div></div>'),a.put("module/partials/calendar-view.html",'<div ng-show="show" class="calendar-view"><div class="container-months"><div ng-include="includeMonths"></div></div><div class="info-block"><div class="info-label" ng-if="!exact"><div class=""><div class="info-label-value">{{ after | date:\'yyyy.MM.dd\' }}</div></div><div><div class="info-label-value">{{ before | date:\'yyyy.MM.dd\' }}</div></div><div><div class="button" ng-click="apply()">Close</div></div></div><div class="info-label" ng-if="exact"><div class=""><div class="info-label-value">{{ exact | date:\'dd.MM.yyyy\' }}</div></div><div><div class="button" ng-click="apply()">Close</div></div></div></div></div>'),a.put("module/partials/container-months.html",'<table><tr><td><!--текущий--><div class="block-month"><daysweek></daysweek><div class="border-line"><div class="btn-back" ng-click="stepBack()">&#8249;</div><div class="btn-forward" ng-click="stepForward()">&#8250;</div></div><div class="row name-month">{{arrMonth.value | date:\'MMMM yyyy\'}}</div><div class="numeric"><div class="row" ng-repeat="week in arrMonth track by $index"><div class="col-day text-right {{day.class}}" ng-repeat="day in arrMonth[$index] track by $index" ng-click="selectEvent(day)"><span ng-switch="$index"><span ng-switch-when="6" class="red">{{day.value | date:\'d\'}}</span> <span ng-switch-when="5" class="red">{{day.value | date:\'d\'}}</span> <span ng-switch-default>{{day.value | date:\'d\'}}</span></span></div></div></div></div></td></tr></table>')}]);