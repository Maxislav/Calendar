var calendarModule=angular.module("calendarModule",[]).constant("constantCalendar",{days:["П","B","C","Ч","П","С","B"]});calendarModule.directive("calendar",["$compile","$templateCache","constantCalendar","$timeout","factoryPosition","serviceDaysWeek",function(a,b,c,d,e){function f(a,b){function c(a){var b="";return e==a.getTime()&&(b+="current"),!k&&f<=a.getTime()&&a.getTime()<=g&&(b+=" select"),k==a.getTime()&&(b+=" select"),d(a)&&(b+=" blocked"),b}function d(a){return h&&h.getTime()<a.getTime()?!0:i&&a.getTime()<i.getTime()?!0:!1}for(var e=new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()).getTime(),f=b.after?b.after.getTime():null,g=b.before?b.before.getTime():null,h=b.maxDate||null,i=b.minDate||null,j=b.startWeek||1,k=b.exact?b.exact.getTime():null,l=[],m=0;50>m;m++){var n=new Date(a.getFullYear(),a.getMonth(),m);n.getMonth()==a.getMonth()&&l.push({date:n,value:n.getTime(),dayWeek:n.getDay(),blocked:d(n),"class":c(n)})}var o,p;0==j?(o=l[0].dayWeek,p=6-l[l.length-1].dayWeek):(o=0==l[0].dayWeek?6:l[0].dayWeek-1,p=0==l[l.length-1].dayWeek?0:7-l[l.length-1].dayWeek);for(var m=0;o>m;m++)l.unshift(null);for(var m=0;p>m;m++)l.push(null);for(var q=parseFloat((l.length/7).toFixed(0)),r=[],s=0,m=0;q>m;m++){r[m]=[];for(var n=0;7>n;n++)r[m].push(l[s]),s++}return r}return{restrict:"EA",replace:!0,templateUrl:function(a,b){return b.exact?(console.log(b),"module/partials/calendar-label-exact.html"):"module/partials/calendar-label.html"},scope:{before:"=before",after:"=after",link:"@link",viewMonths:"@viewMonths",formatDate:"@formatDate",maxDate:"=",minDate:"=",startWeek:"@",exact:"="},controller:["$scope","$element","$attrs","$timeout","$templateCache","serviceDaysWeek",function(a,b,d,e,g,h){function i(b){function c(c){var d=-1*Math.ceil(a.viewMonths/2)+c+1,e=new Date(b.getFullYear(),b.getMonth()+d);return e}for(var d=0;d<a.viewMonths;d++){var e=c(d),g=!1,h=!1;0===d&&(g=!0),d===a.viewMonths-1&&(h=!0),a.months[d]={formatMonth:f(e,{after:a.afterLabelValue,before:a.beforeLabelValue,exact:a.exactLabelValue,maxDate:a.maxDate,minDate:a.minDate,startWeek:a.startWeek}),value:e.getTime(),btnBack:g,btnForward:h}}}function j(c){var d=!1;angular.forEach(a.calendarElement.find("*"),function(a){return a==c.target?void(d=!0):void 0}),d||angular.forEach(b.find("*"),function(a){return a==c.target?void(d=!0):void 0}),d||(a.show=!1,a.$apply())}function k(){window.document.removeEventListener("click",j)}var l="true"==a.link?!0:!1;a.viewMonths=parseFloat(a.viewMonths)||3,a.formatDate=a.formatDate||"yyyy.MM.dd",a.exact&&(h.exact=!0),console.log(a.exact),a.show=!1,a.constantCalendar=c,a.months=[],a.beforeLabelValue=a.before||new Date,a.afterLabelValue=a.after||new Date,a.exact&&(a.exactLabelValue=a.exact||new Date);var m=new Date(a.afterLabelValue.getTime()+(a.beforeLabelValue.getTime()-a.afterLabelValue.getTime())/2);a.includeMonths="module/partials/container-months.html",i(m),a.stepBack=function(){var a=new Date(m.getFullYear(),m.getMonth()-1,m.getDate());m=a,i(a)},a.stepForward=function(){var a=new Date(m.getFullYear(),m.getMonth()+1,m.getDate());m=a,i(a)},a.selectEvent=function(b){return b&&!b.blocked?a.exactLabelValue?(a.exactLabelValue=new Date(b.value),void(l&&(a.exact=a.exactLabelValue))):void(a.beforeLabelValue.getTime()<b.value?(a.beforeLabelValue=new Date(b.value),l&&(a.before=a.beforeLabelValue)):b.value<a.afterLabelValue.getTime()?(a.afterLabelValue=new Date(b.value),l&&(a.after=a.afterLabelValue)):(a.afterLabelValue=new Date(b.value),a.beforeLabelValue=new Date(b.value),l&&(a.before=a.beforeLabelValue,a.after=a.afterLabelValue))):void 0},a.apply=function(){a.before=a.beforeLabelValue,a.after=a.afterLabelValue,a.exact=a.exactLabelValue,a.click()},a.$watch("before",function(b){b!=a.beforeLabelValue&&(a.beforeLabelValue=b),i(m)}),a.$watch("after",function(b){b!=a.afterLabelValue&&(a.afterLabelValue=b),i(m)}),a.$watch("exactLabelValue",function(b){b!=a.exactLabelValue&&(a.exactLabelValue=b),i(m)}),a.$watchCollection("[beforeLabelValue,afterLabelValue,maxDate, minDate]",function(){i(m)}),a.$watch("show",function(a){a?window.document.addEventListener("click",j):window.document.removeEventListener("click",j)}),a.$on("$destroy",function(){a.show=!1,a.calendarElement&&a.calendarElement[0].parentNode.removeChild(a.calendarElement[0]),k()})}],link:function(c,f){function g(){var g=a(b.get("module/partials/calendar-view.html"));h=g(c),h.css("display","none");var i=angular.element(document.body);i.append(h),c.calendarElement=h,d(function(){c.show=!0,h.css("display","inherit"),h.css("left",e(f[0]).x+100+"px"),h.css("top",e(f[0]).y+25+"px")},1)}var h=null;c.show=!1,c.content,c.click=function(){return h?void(c.show=!c.show):void g()}}}}]),calendarModule.directive("daysweek",["$compile","constantCalendar","serviceDaysWeek",function(a,b){return{restrict:"E",replace:!0,scope:{startWeek:"@"},templateUrl:"module/partials/calendar-days.html",link:function(a){if(a.days=[],0==a.startWeek){for(var c=1;c<b.days.length;c++)a.days.push({text:b.days[c],n:c-1});a.days.push({text:b.days[0],n:0}),a.days}else angular.forEach(b.days,function(b,c){a.days.push({text:b,n:6===c?0:c+1})})},controller:["$scope",function(){}]}}]),angular.module("calendarModule").directive("labelTemplate",["$templateCache","calendarSettings","serviceDaysWeek",function(a,b){return{restrict:"C",template:b.config.labelTemlate||a.get("module/partials/calendar-label-template.html")}}]).directive("labelTemplateExact",["$templateCache","calendarSettings","serviceDaysWeek",function(a){return{restrict:"C",template:a.get("module/partials/calendar-label-template-exact.html")}}]),angular.module("calendarModule").factory("calendarSettings",function(){var a={config:{labelTemlate:"{{after | date:'dd MMM'}} - {{before | date:'dd MMM'}} {{before | date:'yy'}}"}};return a}),calendarModule.factory("factoryPosition",function(){function a(a){var b=0;if(a.offsetParent)for(;;){if(b+=a.offsetLeft,!a.offsetParent)break;a=a.offsetParent}else a.x&&(b+=a.x);return b}function b(a){var b=0;if(a.offsetParent)for(;;){if(b+=a.offsetTop,!a.offsetParent)break;a=a.offsetParent}else a.y&&(b+=a.y);return b}function c(c){return{x:a(c),y:b(c)}}return c}),angular.module("calendarModule").run(["$templateCache",function(a){"use strict";a.put("module/partials/calendar-days.html",'<div class="row days"><div class="col-day text-right" ng-repeat="day in days track by $index"><span ng-switch="day.n"><span ng-switch-when="0" class="red">{{day.text}}</span> <span ng-switch-when="6" class="red">{{day.text}}</span> <span ng-switch-default>{{day.text}}</span></span></div></div>'),a.put("module/partials/calendar-label-exact.html",'<div class="calendar-label"><div class="calendar-label-btn" ng-class="show && \'open\'" ng-click="click()"><div class="label-template-exact"></div></div><div class="calendar-label-ico" ng-click="click()"><div class="ico-calendar">&nbsp;</div></div></div>'),a.put("module/partials/calendar-label-template-exact.html","{{exact | date:'dd MMM yyyy'}}"),a.put("module/partials/calendar-label-template.html","{{after | date:'dd MMM'}} - {{before | date:'dd MMM'}} {{before | date:'yyyy'}}"),a.put("module/partials/calendar-label.html",'<div class="calendar-label"><div class="calendar-label-btn" ng-class="show && \'open\'" ng-click="click()"><div class="label-template"></div></div><div class="calendar-label-ico" ng-click="click()"><div class="ico-calendar">&nbsp;</div></div></div>'),a.put("module/partials/calendar-view.html",'<div ng-show="show" class="calendar-view"><div class="container-months"><div ng-include="includeMonths"></div></div><div class="info-block"><div class="info-label" ng-if="!exact"><div class="col-4"><div class="info-label-value">{{ after | date:formatDate }}</div></div><div class="col-4"><div class="info-label-value">{{ before | date:formatDate }}</div></div><div class="col-4"><div class="button" ng-click="apply()">Применить</div></div></div><div class="info-label" ng-if="exact"><div class="col-8"><div class="info-label-value">{{ exact | date:formatDate }}</div></div><div class="col-4"><div class="button" ng-click="apply()">Применить</div></div></div></div></div>'),a.put("module/partials/container-months.html",'<table><tr><td ng-repeat="month in months track by $index"><div class="block-month"><daysweek start-week="{{startWeek}}"></daysweek><div class="border-line"><div class="btn-back" ng-click="stepBack()" ng-if="month.btnBack">&#8249;</div><div class="btn-forward" ng-click="stepForward()" ng-if="month.btnForward">&#8250;</div></div><div class="row name-month">{{month.value | date:\'MMMM yyyy\'}}</div><div class="numeric"><div class="row" ng-repeat="week in month.formatMonth track by $index"><div class="col-day text-right {{day.class}}" ng-repeat="day in month.formatMonth[$index] track by $index" ng-click="selectEvent(day)"><span ng-switch="day.dayWeek"><span ng-switch-when="6" class="red">{{day.value | date:\'d\'}}</span> <span ng-switch-when="0" class="red">{{day.value | date:\'d\'}}</span> <span ng-switch-default>{{day.value | date:\'d\'}}</span></span></div></div></div></div></td></tr></table>')}]),angular.module("calendarModule").service("serviceDaysWeek",function(){this.startWeek,this.exact=!1});